<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <!-- polyfill -->
    <script src="midijs/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="midijs/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="midijs/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="midijs/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="midijs/js/midi/gm.js" type="text/javascript"></script>
    <script src="midijs/js/midi/loader.js" type="text/javascript"></script>
    <script src="midijs/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="midijs/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="midijs/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!--<script src="midijs/js/midi/player.js"></script>-->
    <!-- utils -->
    <script src="midijs/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="midijs/js/util/dom_request_script.js" type="text/javascript"></script>

    <script src="index.js"></script>
    <title>Title</title>
</head>
<body>
<script type="text/javascript">

    window.onload = function () {
        MIDI.loadPlugin({
            soundfontUrl: "midijs/examples/soundfont/",
            instrument: "acoustic_grand_piano",
            onprogress: function (state, progress) {
                console.log(state, progress);
            },
            onsuccess: function () {
                console.log('load success');
                var play = true;
                // time up to that notes are loaded into player
                var timeOfStartButtonPress = Date.now();
                // min time buffer that should be loaded into player
                var minTimeBufferMs = 2000;
                // time that will be requested from server
                var secondsToLoadNotes = 4;

                window.setInterval(function fillPlayer() {
                    var timeInBufferToPlay = timeOfStartButtonPress + player.timeline * 1000 - Date.now();
                    if (timeInBufferToPlay < minTimeBufferMs) {
                        console.log("loading notes to player... time in Buffer left to play = " + timeInBufferToPlay + " min time buffer = " + minTimeBufferMs);
                        playNextTBars(secondsToLoadNotes/player.barDuration, true);
                    } else {
                        console.log("waiting... time in Buffer left to play = " + timeInBufferToPlay + " min time buffer = " + minTimeBufferMs);
                    }
                }, 2000);
            }
        });
    };

    var player = {
        barDuration: 2,
        // in seconds
        timeline: 1,
        velocity: 127,
        play: function (noteInt, rhythmValue, moveTime) {

            MIDI.noteOn(0, noteInt, this.velocity, this.timeline);
            // звучание ноты заканчивается через длительность такта * длительность ноты в такте
            // rhythmValue = 4 - this is the WHOLE NOTE, so we are dividing on 4 to get bar rhythm value
            var endTime = this.barDuration * rhythmValue / 4;
            MIDI.noteOff(0, noteInt, this.velocity, this.timeline + endTime);

            if (typeof moveTime !== 'undefined' && moveTime === true) {
                this.timeline += endTime
            }
        }
    };

</script>
</body>
</html>
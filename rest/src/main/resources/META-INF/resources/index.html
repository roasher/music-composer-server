<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <!-- polyfill -->
    <script src="midijs/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="midijs/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="midijs/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="midijs/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="midijs/js/midi/gm.js" type="text/javascript"></script>
    <script src="midijs/js/midi/loader.js" type="text/javascript"></script>
    <script src="midijs/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="midijs/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="midijs/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!--<script src="midijs/js/midi/player.js"></script>-->
    <!-- utils -->
    <script src="midijs/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="midijs/js/util/dom_request_script.js" type="text/javascript"></script>

    <script src="index.js"></script>
    <title>Title</title>
</head>
<body>
<script type="text/javascript">

    var barDuration = 4;
    var velocity = 127;

    class PartPlayer {
        constructor() {
            // in seconds
            this.timeline = 1;
        }

        play(noteInt, rhythmValue, moveTime) {
            var duration = barDuration * rhythmValue / 4;
            // play the note
            MIDI.noteOn(0, noteInt, velocity, this.timeline);
            MIDI.noteOff(0, noteInt, this.timeline + duration);

            if (typeof moveTime !== 'undefined' && moveTime === true) {
                this.timeline += duration
            }
        }
    }

    class Player {
        constructor(partNumber) {
            this.partPlayers = [];
            for (var currentPartNumber = 0; currentPartNumber < partNumber; currentPartNumber++) {
                this.partPlayers.push(new PartPlayer())
            }
        }

        getTimeLine() {
            var minTimeLine;
            for (var currentPartNumber = 0; currentPartNumber < this.partPlayers.length; currentPartNumber++) {
                if (!minTimeLine || minTimeLine < this.partPlayers[currentPartNumber].timeline) {
                    minTimeLine = this.partPlayers[currentPartNumber].timeline;
                }
            }
            return minTimeLine;
        }
    }

    window.onload = function () {
        MIDI.loadPlugin({
            soundfontUrl: "midijs/examples/soundfont/",
            instrument: "acoustic_grand_piano",
            onprogress: function (state, progress) {
                console.log(state, progress);
            },
            onsuccess: function () {
                console.log('load success');
                var player = new Player(4);
                // time up to that notes are loaded into player
                var timeOfStartButtonPress = Date.now();
                // min time buffer that should be loaded into player
                var minTimeBufferMs = 2000;
                // time that will be requested from server
                var secondsToLoadNotes = 4;

                var fillPlayer = function fillPlayer() {
                    var timeInBufferToPlay = timeOfStartButtonPress + player.getTimeLine() * 1000 - Date.now();
                    if (timeInBufferToPlay < minTimeBufferMs) {
                        console.log("loading notes to player... time in Buffer left to play = " + timeInBufferToPlay + " min time buffer = " + minTimeBufferMs);
                        playNextTBars("session1", secondsToLoadNotes / barDuration, player);
                    } else {
                        console.log("waiting... time in Buffer left to play = " + timeInBufferToPlay + " sec time buffer = " + minTimeBufferMs);
                    }
                };
                window.setInterval(fillPlayer, 2000);
//                fillPlayer()
            }
        });
    };


</script>
</body>
</html>